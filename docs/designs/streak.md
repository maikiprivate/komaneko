# ã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼ˆé€£ç¶šå­¦ç¿’ï¼‰æ©Ÿèƒ½è¨­è¨ˆ

## æ¦‚è¦

Duolingoé¢¨ã®ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ¼”å‡ºã§ã€ãã®æ—¥ã®æœ€åˆã®å­¦ç¿’å®Œäº†æ™‚ã«ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ›´æ–°ã‚’ç¥ã†UIã€‚

## è¦ä»¶

| é …ç›® | å†…å®¹ |
|------|------|
| è¡¨ç¤ºã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãã®æ—¥ã®æœ€åˆã®å­¦ç¿’å®Œäº†å¾Œ |
| å¯¾è±¡ | ãƒ¬ãƒƒã‚¹ãƒ³ã¨è©°å°†æ£‹ã®ä¸¡æ–¹ï¼ˆå°†æ¥ã®æ‹¡å¼µã«ã‚‚å¯¾å¿œï¼‰ |
| è¡¨ç¤ºæ–¹æ³• | ç”»é¢é·ç§»ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã¯ãªã„ï¼‰ |
| é·ç§»å…ˆ | è¡¨ç¤ºå¾Œã€å…ƒã®ç”»é¢ã«æˆ»ã‚‹ |
| UI | Duolingoé¢¨ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ |
| ãƒ‡ãƒ¼ã‚¿ç®¡ç† | AsyncStorageã§ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ |
| ãƒ›ãƒ¼ãƒ é€£æº | æ›´æ–°å¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’åæ˜  |

## ç”»é¢ãƒ•ãƒ­ãƒ¼

```
å­¦ç¿’å®Œäº†ï¼ˆãƒ¬ãƒƒã‚¹ãƒ³/è©°å°†æ£‹/å°†æ¥ã®æ©Ÿèƒ½ï¼‰
       â†“
recordLearningCompletion() ã‚’å‘¼ã³å‡ºã—
       â†“
 [ãã®æ—¥ã®æœ€åˆã‹åˆ¤å®š]
       â†“
  YES â†’ { updated: true, newCount: N } ã‚’è¿”ã™
  NO  â†’ { updated: false } ã‚’è¿”ã™
       â†“
updated === true ã®å ´åˆ
       â†“
router.push('/streak-update?count=N')
       â†“
ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ›´æ–°ç”»é¢è¡¨ç¤º â†’ ã€Œç¶šã‘ã‚‹ã€ã‚¿ãƒƒãƒ— â†’ router.back()
```

## è¨­è¨ˆæ–¹é‡

### 1. æŸ”è»Ÿãªçµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³

å„ç”»é¢ã‹ã‚‰ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã¶ã®ã§ã¯ãªãã€**å…±é€šé–¢æ•°**ã‚’ç”¨æ„ï¼š

```typescript
// ã©ã®ç”»é¢ã‹ã‚‰ã‚‚å‘¼ã¹ã‚‹å…±é€šé–¢æ•°
const result = await recordLearningCompletion()

if (result.updated) {
  router.push(`/streak-update?count=${result.newCount}`)
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- æ–°ã—ã„å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¿½åŠ æ™‚ã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã§çµ±åˆå¯èƒ½
- ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´ãŒ1ç®‡æ‰€ã§æ¸ˆã‚€

### 2. ç”»é¢é·ç§»

**ãƒ«ãƒ¼ãƒˆ**: `/streak-update`

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
- `count`: æ›´æ–°å¾Œã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ•°

### 3. ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ›´æ–°

`useFocusEffect` ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«AsyncStorageã‹ã‚‰å†èª­ã¿è¾¼ã¿ã€‚

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```typescript
interface StreakData {
  currentCount: number      // ç¾åœ¨ã®é€£ç¶šæ—¥æ•°
  longestCount: number      // æœ€é•·è¨˜éŒ²
  lastActiveDate: string | null  // æœ€çµ‚å­¦ç¿’æ—¥ (YYYY-MM-DD)
}
```

## ã‚¹ãƒˆãƒªãƒ¼ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```typescript
// ä»Šæ—¥ã™ã§ã«å­¦ç¿’æ¸ˆã¿ â†’ æ›´æ–°ãªã—
if (lastActiveDate === today) return { updated: false }

// æ˜¨æ—¥ã‚‚å­¦ç¿’ â†’ ã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¶™ç¶š
if (lastActiveDate === yesterday) newCount = currentCount + 1

// ãã‚Œä»¥å¤– â†’ ãƒªã‚»ãƒƒãƒˆ
else newCount = 1
```

## UIæ§‹æˆ

```
+----------------------------------+
|                                  |
|      ğŸ”¥ (ç«ã®ã‚¢ã‚¤ã‚³ãƒ³/ã‚¢ãƒ‹ãƒ¡)    |
|                                  |
|          [ 3 ] æ—¥é€£ç¶šï¼          |
|                                  |
|     ä»Šæ—¥ã‚‚é ‘å¼µã£ãŸã«ã‚ƒï¼         |
|     ã“ã®èª¿å­ã§ç¶šã‘ã‚‹ã«ã‚ƒã€œ       |
|                                  |
|        ğŸ± (ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼)         |
|                                  |
|  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
|  â”‚         ç¶šã‘ã‚‹             â”‚  |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  |
|                                  |
+----------------------------------+
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
packages/app/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ streak-update.tsx         # ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ›´æ–°ç”»é¢
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ streak/
â”‚       â”œâ”€â”€ streakStorage.ts      # AsyncStorageãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â””â”€â”€ recordLearningCompletion.ts  # å­¦ç¿’å®Œäº†è¨˜éŒ²é–¢æ•°
```

---

## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIï¼ˆPhase 13ï¼‰

### æ¦‚è¦

ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†ã—ã€è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã§ã®åŒæœŸã‚’å¯èƒ½ã«ã™ã‚‹ã€‚

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èª¬æ˜ | èªè¨¼ |
|---------|------|------|------|
| GET | /api/streak | ã‚¹ãƒˆãƒªãƒ¼ã‚¯çŠ¶æ…‹å–å¾— | å¿…é ˆ |
| POST | /api/streak/record | å­¦ç¿’å®Œäº†è¨˜éŒ² | å¿…é ˆ |

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆPrismaã‚¹ã‚­ãƒ¼ãƒæ—¢å­˜ï¼‰

```prisma
model Streak {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  currentCount   Int       @default(0) @map("current_count")
  longestCount   Int       @default(0) @map("longest_count")
  lastActiveDate DateTime? @map("last_active_date")
  updatedAt      DateTime  @updatedAt @map("updated_at")
}
```

### APIãƒ¬ã‚¹ãƒãƒ³ã‚¹

**GET /api/streak**
```json
{
  "data": {
    "currentCount": 5,
    "longestCount": 14,
    "lastActiveDate": "2025-12-17",
    "updatedToday": true
  }
}
```

**POST /api/streak/record**
```json
{
  "data": {
    "updated": true,
    "currentCount": 6,
    "longestCount": 14
  }
}
```

### ã‚¹ãƒˆãƒªãƒ¼ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰

```typescript
// ç¾åœ¨æ™‚åˆ»ã‚’JSTã§å–å¾—ï¼ˆæ—¥æœ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰
const today = getJSTDateString()
const yesterday = getYesterdayJST()

// ä»Šæ—¥ã™ã§ã«è¨˜éŒ²æ¸ˆã¿ â†’ æ›´æ–°ãªã—
if (lastActiveDate === today) {
  return { updated: false, currentCount }
}

// æ˜¨æ—¥ã‚‚å­¦ç¿’ â†’ ã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¶™ç¶š
if (lastActiveDate === yesterday) {
  newCount = currentCount + 1
}
// ãã‚Œä»¥å¤– â†’ ãƒªã‚»ãƒƒãƒˆ
else {
  newCount = 1
}

// DBæ›´æ–°
await updateStreak(userId, {
  currentCount: newCount,
  longestCount: Math.max(longestCount, newCount),
  lastActiveDate: today
})
```

### è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ

1. **Hearts APIã¨åŒãƒ‘ã‚¿ãƒ¼ãƒ³**
   - å–å¾—æ™‚: DBã‹ã‚‰èª­ã¿è¾¼ã¿ã€æ›´æ–°ãªã—
   - è¨˜éŒ²æ™‚: ã‚¹ãƒˆãƒªãƒ¼ã‚¯åˆ¤å®šâ†’DBæ›´æ–°

2. **ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†**
   - JSTï¼ˆæ—¥æœ¬æ¨™æº–æ™‚ï¼‰åŸºæº–ã§æ—¥ä»˜åˆ¤å®š
   - ã‚µãƒ¼ãƒãƒ¼å´ã§çµ±ä¸€çš„ã«å‡¦ç†

3. **é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿**
   - Phase 13ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã¯ `currentCount`, `longestCount`, `lastActiveDate` ã®ã¿ç®¡ç†
   - `completedDates`ï¼ˆé€±é–“è¡¨ç¤ºç”¨ï¼‰ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´AsyncStorageã§ç¶™ç¶šç®¡ç†
   - å°†æ¥çš„ã«è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œãŒå¿…è¦ã«ãªã£ãŸã‚‰æ‹¡å¼µ

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆAPIå´ï¼‰

```
packages/api/src/modules/streak/
â”œâ”€â”€ streak.router.ts        # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ streak.service.ts       # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ streak.service.test.ts  # ã‚µãƒ¼ãƒ“ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆTDDï¼‰
â”œâ”€â”€ streak.repository.ts    # DBã‚¢ã‚¯ã‚»ã‚¹
â””â”€â”€ streak.schema.ts        # Zodã‚¹ã‚­ãƒ¼ãƒ
```

### ã‚¢ãƒ—ãƒªå´ã®å¤‰æ›´

```
packages/app/lib/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ streak.ts           # getStreak(), recordStreak()
â””â”€â”€ streak/
    â”œâ”€â”€ useStreak.ts        # çŠ¶æ…‹ç®¡ç†ãƒ•ãƒƒã‚¯ï¼ˆæ–°è¦ï¼‰
    â””â”€â”€ recordLearningCompletion.ts  # APIå‘¼ã³å‡ºã—ã«å¤‰æ›´
```

---

## å°†æ¥æ‹¡å¼µ

### ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å¯¾å¿œ

```typescript
const MILESTONES = [7, 30, 100, 365]

// streak-update.tsx ã§ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åˆ¤å®š
const isMilestone = MILESTONES.includes(streakCount)
```

7æ—¥ã€30æ—¥ç­‰ã®ç¯€ç›®ã§ç‰¹åˆ¥ãªæ¼”å‡ºã‚’è¿½åŠ äºˆå®šã€‚

### è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼ˆå°†æ¥ï¼‰

`completedDates`ã‚’ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã«ç§»è¡Œ:
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: Streakãƒ†ãƒ¼ãƒ–ãƒ«ã«`completedDates`ï¼ˆJSONå‹ï¼‰ã‚’è¿½åŠ 
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«`streak_activities`ã‚’ä½œæˆ
