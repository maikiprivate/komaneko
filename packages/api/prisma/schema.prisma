// 駒猫 Prisma スキーマ
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ユーザー・認証 ==========

model User {
  id           String   @id @default(uuid())
  email        String?  @unique
  username     String?  @unique
  passwordHash String?  @map("password_hash")
  isAnonymous  Boolean  @default(true) @map("is_anonymous")
  role         String   @default("user") // "user" | "admin"
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sessions        Session[]
  hearts          Hearts?
  learningRecords LearningRecord[]

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ========== ゲーミフィケーション ==========

model Hearts {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  count             Int      @default(10)
  maxCount          Int      @default(10) @map("max_count")
  recoveryStartedAt DateTime @default(now()) @map("recovery_started_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("hearts")
}

// ========== 学習記録 ==========

model LearningRecord {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  contentType   String    @map("content_type")  // "tsumeshogi" | "lesson" | "joseki"
  isCompleted   Boolean   @default(false) @map("is_completed")
  completedDate String?   @map("completed_date")  // "YYYY-MM-DD" (JST) 完了時のみ
  createdAt     DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // コンテンツ別詳細（1対1、どれか1つのみ紐づく）
  tsumeshogiRecord TsumeshogiRecord?
  lessonRecord     LessonRecord?

  @@index([userId, completedDate])
  @@index([userId, isCompleted])
  @@map("learning_records")
}

model TsumeshogiRecord {
  id               String   @id @default(uuid())
  learningRecordId String   @unique @map("learning_record_id")
  tsumeshogiId     String   @map("tsumeshogi_id")
  isCorrect        Boolean  @default(false) @map("is_correct")

  learningRecord LearningRecord @relation(fields: [learningRecordId], references: [id], onDelete: Cascade)

  @@index([tsumeshogiId])
  @@map("tsumeshogi_records")
}

model LessonRecord {
  id                String @id @default(uuid())
  learningRecordId  String @unique @map("learning_record_id")
  lessonId          String @map("lesson_id") // モックデータのID
  correctCount      Int    @default(0) @map("correct_count") // 初回正解数
  completionSeconds Int?   @map("completion_seconds") // 完了時間（秒）

  learningRecord  LearningRecord         @relation(fields: [learningRecordId], references: [id], onDelete: Cascade)
  problemAttempts LessonProblemAttempt[]

  @@index([lessonId])
  @@map("lesson_records")
}

model LessonProblemAttempt {
  id             String  @id @default(uuid())
  lessonRecordId String  @map("lesson_record_id")
  problemId      String  @map("problem_id") // モックデータの問題ID
  problemIndex   Int     @map("problem_index") // 問題番号（0-indexed）
  isCorrect      Boolean @map("is_correct") // 初回正解したか（ヒント・解答なしで一発正解）
  usedHint       Boolean @default(false) @map("used_hint")
  usedSolution   Boolean @default(false) @map("used_solution")

  lessonRecord LessonRecord @relation(fields: [lessonRecordId], references: [id], onDelete: Cascade)

  @@index([lessonRecordId])
  @@map("lesson_problem_attempts")
}

// ========== コンテンツ ==========

model Tsumeshogi {
  id        String   @id @default(uuid())
  sfen      String   // 局面（SFEN形式）
  moveCount Int      @map("move_count") // 手数（3, 5, 7 など）
  status    String   @default("draft") // draft, published, archived
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([moveCount, status])
  @@map("tsumeshogis")
}
